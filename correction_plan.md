# Rogue 3D: Correction Plan

## Цель
Убрать визуальные дефекты 3D-режима, которые ухудшают читаемость сцены, прицеливание и ощущение глубины, без регрессий в производительности и геймплейных взаимодействиях.

## Выявленные проблемы

### P0. Спрайты всегда рисуются 3x3 в центре экрана, без реального масштабирования и вертикального позиционирования
- Где:
  - `presentation/rendering/sprite_renderer_3d.py:178` (считается `sprite.height`)
  - `presentation/rendering/sprite_renderer_3d.py:185` (высота сохраняется)
  - `presentation/rendering/sprite_renderer_3d.py:219` (`center_y = self.viewport_height // 2`)
  - `presentation/rendering/sprite_renderer_3d.py:250` (жестко 3x3 паттерн)
- Проблема:
  - Вычисленная высота спрайта не используется при рендере.
  - Все сущности выглядят одинаково крупными и «приклеенными» к центру.
- Влияние на UX:
  - Сломана перспектива, цели «плавают» и хуже читаются по дистанции.

### P0. Рассинхрон FOV между стенами/камерой и спрайтами
- Где:
  - `presentation/renderer_3d.py:64` (`SpriteRenderer(..., fov=60.0)`)
  - `presentation/rendering/raycasting.py:125` (лучи используют `camera.fov`)
  - `presentation/rendering/sprite_renderer_3d.py:154` (проекция спрайтов использует `self.fov`)
- Проблема:
  - Геометрия стен зависит от `camera.fov`, а спрайты проецируются с захардкоженным 60°.
- Влияние на UX:
  - При измененном FOV спрайты визуально «съезжают» относительно мира и ретикла.

### P0. Некорректный depth-test спрайтов: проверка по 3 колонкам, но рисование полного 3x3 без per-pixel z
- Где:
  - `presentation/rendering/sprite_renderer_3d.py:236` (z-проверка только для `sx-1/sx/sx+1`)
  - `presentation/rendering/sprite_renderer_3d.py:250` (после прохождения проверки рисуется весь блок)
- Проблема:
  - Частично закрытые стены/углы не клиппируют спрайт посимвольно.
- Влияние на UX:
  - «Протекание» спрайтов через стены и заметные артефакты на углах.

### P1. Неправильная метрика глубины для масштаба спрайтов
- Где:
  - `presentation/rendering/sprite_renderer_3d.py:159` (используется евклидова `dist`)
  - `presentation/rendering/sprite_renderer_3d.py:164` (есть `forward`, но не используется в масштабе)
- Проблема:
  - Размер спрайта зависит от прямого расстояния, а стены используют перпендикулярную дистанцию.
- Влияние на UX:
  - На краях экрана спрайты выглядят меньше, чем должны, и «пульсируют» при повороте камеры.

### P1. Плоский пол/потолок без перспективного градиента
- Где:
  - `presentation/renderer_3d.py:196` (`floor_char` вычисляется один раз на всю колонку)
  - `presentation/renderer_3d.py:197` (весь пол колонки заполняется одним символом)
  - `presentation/renderer_3d.py:179` (потолок всегда пробелами)
- Проблема:
  - Нет y-зависимого затухания/текстуры пола и потолка.
- Влияние на UX:
  - Сцена выглядит «картонной», теряется ощущение глубины и скорости движения.

### P1. Слабая глубинная подсказка по сторонам стен
- Где:
  - `presentation/renderer_3d.py:207` (`side` передается, но при выборе цвета фактически не влияет)
- Проблема:
  - Для NS/EW граней нет дополнительного ослабления/подсветки.
- Влияние на UX:
  - Хуже читается форма коридоров и углов, особенно на одинаковых текстурах.

### P2. Слишком раннее исчезновение дальних спрайтов
- Где:
  - `presentation/rendering/sprite_renderer_3d.py:292` (`distance < 15` -> `·`, иначе `' '`)
  - `presentation/rendering/sprite_renderer_3d.py:49` (`max_sprite_distance = 20.0`)
- Проблема:
  - Спрайт может быть в допустимой дистанции, но уже невидим из-за шейдера.
- Влияние на UX:
  - Заметный pop-in/pop-out объектов.

### P2. Рассинхрон ретикла и логики выбора цели при нестандартной ширине viewport
- Где:
  - `presentation/game_ui.py:225` (`get_entity_in_front(level)` вызывается без `viewport_width`)
  - `presentation/camera/controller.py:122` (fallback использует фиксированное допущение через `80.0`)
  - `presentation/game_ui.py:239` (ретикл рисуется по фактическому viewport)
- Проблема:
  - Логика выбора цели использует аппроксимацию, хотя реальная ширина viewport известна.
- Влияние на UX:
  - Визуально «наведен», но цель не выбирается (или наоборот), что ломает доверие к прицеливанию.

## Пошаговый план исправления

### Этап 1. Синхронизировать проекцию и таргетинг (быстрые победы)
1. Передавать фактический `camera.fov` в `SpriteRenderer` на каждый кадр или хранить ссылку на камеру.
2. Убрать hardcode `fov=60.0` из `Renderer3D` и использовать единый источник FOV.
3. Передавать `viewport_width` в `camera_controller.get_entity_in_front(...)` из `game_ui`.
4. Удалить fallback с «80 колонками» из прицела либо использовать его только как аварийный путь.
5. Критерий приемки:
   - При FOV 50/60/75 спрайт, ретикл и hit-detection совпадают по центру экрана.

### Этап 2. Нормализовать геометрию спрайтов
1. Использовать `forward` (перпендикулярную дистанцию к камере) для расчета высоты/масштаба.
2. Добавить реальные `sprite_screen_height` и `sprite_screen_width` с клампами.
3. Ввести вертикальный якорь (foot anchoring): низ спрайта должен стоять на «линии пола», а не в `center_y`.
4. Перейти с фиксированного 3x3 на масштабируемый billboard (минимум 2x2, максимум по высоте viewport).
5. Критерий приемки:
   - При приближении спрайт плавно растет, при удалении уменьшается без ступенчатых скачков.

### Этап 3. Исправить окклюзию и клиппинг
1. Делать depth-test для каждой колонки спрайта (или каждого символа), а не только для центра.
2. Рисовать только те символы спрайта, которые проходят `sprite_depth < z_buffer[x]`.
3. Сохранить легкий bias для предметов вплотную к стене, но ограничить его верхним порогом.
4. Критерий приемки:
   - На углах и в дверных проемах нет «протекания» спрайтов через геометрию.

### Этап 4. Улучшить пол/потолок и чтение глубины стен
1. Ввести y-зависимый градиент пола и потолка (distance by scanline).
2. Добавить side-based shading (например, EW грань чуть темнее NS).
3. Опционально: легкий туман по дистанции для унификации стен и спрайтов.
4. Критерий приемки:
   - Глубина читается без миникарты, коридоры не выглядят плоскими.

### Этап 5. Стабилизировать дальние объекты и исключить pop-in
1. Пересмотреть `_shade_char` для спрайтов: вместо `' '` на дальних расстояниях оставить слабый маркер (`·`/`:`).
2. Согласовать `max_sprite_distance` и шейдинг так, чтобы объект не исчезал раньше дальности рендера.
3. Добавить мягкое затухание по 2-3 дистанционным зонам.
4. Критерий приемки:
   - Объекты исчезают предсказуемо и плавно, без резких «миганий».

### Этап 6. Проверка качества и регрессий
1. Добавить визуальные regression-сценарии (узкий коридор, угол, дверь, дальний объект, широкий FOV).
2. Сделать screenshot/golden-master тесты ASCII-кадров для ключевых сцен.
3. Измерить frame-time до/после (цель: без заметной деградации, либо <=10% роста).
4. Принять изменения только после прохождения визуальных и interaction-check тестов.

## Рекомендуемый порядок внедрения (по спринтам)
- Sprint A: Этапы 1-2 (синхронизация + геометрия спрайтов).
- Sprint B: Этап 3 (окклюзия/клиппинг).
- Sprint C: Этапы 4-5 (глубина сцены + стабилизация дальних объектов).
- Sprint D: Этап 6 (автотесты и фиксация baseline).

## Definition of Done
- Спрайты масштабируются и стоят на полу корректно.
- При любом поддерживаемом FOV прицел, видимый спрайт и hit-detection совпадают.
- Нет заметных артефактов окклюзии у стен/дверей/углов.
- Глубина пола/потолка и боковых стен читается визуально.
- Нет резких исчезновений спрайтов в рабочей дальности.

## Статус выполнения
- Этап 1: выполнен.
- Этап 2: выполнен.
- Этап 3: выполнен.
- Этап 4: выполнен.
- Этап 5: выполнен.
- Этап 6: выполнен частично (автотесты и golden snapshot добавлены; замер frame-time выполняется как ручная проверка).

## Реализованные проверки Этапа 6
- Добавлены regression-тесты рендера 3D:
  - `tests/presentation/test_renderer_3d_regressions.py`
- Добавлен golden-master snapshot кадра:
  - `tests/presentation/snapshots/renderer_3d_frame.txt`
- Добавлены regression-тесты спрайтов (дальность/затухание):
  - `tests/presentation/test_sprite_renderer_3d_regressions.py`
- Команда запуска новых проверок:
  - `python -m pytest tests/presentation/test_renderer_3d_regressions.py tests/presentation/test_sprite_renderer_3d_regressions.py -q`
