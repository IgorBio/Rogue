# План рефакторинга (только обоснованные улучшения)

## Цель

Упростить проект без потери функциональности и без нарушения разделения слоёв.

## Проблемы и стратегии исправления

### 1. Несогласованная обработка camera state

**Обоснование:** `GameSession` хранит `restored_camera_state`, а управление камерой выполняется через provider (`ViewManager`). Ответственность распределена неявно, что повышает риск ошибок при save/load.
**Стратегия исправления:**

- Убрать хранение `restored_camera_state` из domain, перенести всю логику восстановления камеры в presentation.
- Явно передавать camera_state в `ViewManager.apply_camera_state()` после load.
- Закрепить контракт: domain хранит только флаг `rendering_mode`, остальное — в presentation.

### 2. Слишком много responsibilities в GameSession

**Обоснование:** `GameSession` крупный и объединяет слишком много сценариев (инициализация, state, статистика, координация сервисов).
**Стратегия исправления:**

- Выделять отдельные методы/микро-классы внутри domain для узких зон (например, отдельный `GameStateController`).
- Сократить прямую логику в `GameSession`, максимально делегируя в координатор.

### 3. Inconsistent error handling (except Exception: pass)

**Обоснование:** подавление ошибок без логирования делает отладку крайне сложной и скрывает реальные проблемы.
**Стратегия исправления:**

- Ввести единый lightweight-логгер или хотя бы минимальные сообщения в stderr.
- Ограничить `except Exception` и заменить на catch конкретных исключений, где возможно.

### 4. Дублирование логики синхронизации позиций

**Обоснование:** есть параллельная логика в domain (`position_synchronizer.py`) и presentation (`camera/sync.py`). Это допустимо по слоям, но чревато рассинхронизацией.
**Стратегия исправления:**

- Закрепить границу: в domain оставлять только чисто доменные функции (без float-координат камеры).
- Все преобразования в camera-координаты держать строго в presentation.

### 5. Дублирование item rendering логики (2D/3D)

**Обоснование:** в 2D и 3D встречаются схожие решения по символам/цветам предметов, риск расхождения.
**Стратегия исправления:**

- Вынести общую функцию/таблицу отображения в отдельный модуль presentation, который используют оба рендера.
- Оставить различия только в отрисовке, не в правилах отображения.

### 6. Неявные зависимости в services через session

**Обоснование:** сервисы опираются на доступ к session, что затрудняет локальное тестирование.
**Стратегия исправления:**

- Минимизировать обращения к session в сервисах, явно передавать нужные зависимости в конструктор.
- Добавить адаптеры/интерфейсы там, где связь слишком неявна.

---

## Не делать

- Удаление `ActionType`.
- Удаление `StateMachine`.
- Полная консолидация всех domain-сервисов в один файл.
- Удаление `EventBus`.
- Удаление `ViewManager`.
