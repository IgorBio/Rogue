# Correction Plan (Обоснованные проблемы и стратегии исправления)

Ниже перечислены только те проблемы, которые подтверждаются текущим кодом и реально влияют на механику/отрисовку. Для каждой — краткая стратегия исправления.

## 1. Несогласованный тип `enemy.position`
**Проблема:** в проекте есть ожидания, что `enemy.position` ведет себя как tuple, но в части кода может быть `Position`. Это риск скрытых ошибок в сравнении/рендеринге.  
**Стратегия:**
- Явно стандартизировать `enemy.position` как `Tuple[int, int]` на уровне публичного API.
- Добавить конвертацию/адаптер при доступе к `_position`.
- Прогнать поиском все сравнения/доступы и привести к одному контракту.

## 2. Крайние случаи видимости в Fog of War
**Проблема:** логика `is_position_visible()` сложная и может некорректно обрабатывать границы между комнатами/коридорами.  
**Стратегия:**
- Сформулировать и задокументировать контракт “что считается видимым”.
- Добавить тесты на граничные случаи (комната↔коридор, видимость дверей/предметов).
- Упростить логику через явный набор `visible_tiles`, обновляемый при движении.

## 3. Отрисовка дверей в FOW (2D)
**Проблема:** `_is_door_near_room()` использует магическое расстояние и может не показывать двери в обнаруженных коридорах.  
**Стратегия:**
- Привязать отображение дверей к состоянию видимости/обнаружения коридора.
- Убрать “магическую” проверку `room.x±2`.
- Добавить тест на видимость дверей в коридорах и на границе комнат.

## 4. Слабое логирование ошибок в рендеринге curses
**Проблема:** многочисленные `except curses.error: pass` скрывают проблемы (например, слишком маленький терминал).  
**Стратегия:**
- Логировать редкие ошибки рендеринга (с throttling).
- Явно показывать пользователю предупреждение при слишком маленьком терминале.

## 5. Дублирование/остатки прямых вызовов stats
**Проблема:** статистика теперь должна обновляться через события, но возможны остатки прямых `stats.record_*` вызовов.  
**Стратегия:**
- Поиск по `record_*` вне `StatisticsTracker`.
- Удаление прямых вызовов или перевод их на события.
- Добавить минимальные тесты, что при загрузке и при движении счетчики продолжают расти.

## 6. Безопасность сохранений (path traversal)
**Проблема:** `SaveManager.save_game()` принимает произвольный `filename` без валидации.  
**Стратегия:**
- Валидировать `filename` (запрет `..`, абсолютных путей).
- Разрешать только базовые имена файлов внутри `save_dir`.

## 7. Производительность FOW и raycasting (низкий приоритет)
**Проблема:** пересчет видимости и лучей может быть дорогим при частых кадрах.  
**Стратегия:**
- Пересчитывать видимость только при движении.
- Кэшировать лучи/видимые тайлы в комнатах.

---

## Рекомендуемый порядок исправлений
1. `enemy.position` контракт  
2. Fog of War видимость (логика + тесты)  
3. Двери в FOW  
4. Логирование ошибок рендера  
5. Поиск и устранение прямых `stats.record_*`  
6. Валидация `SaveManager`  
7. Оптимизации FOW/raycasting (после стабилизации)
